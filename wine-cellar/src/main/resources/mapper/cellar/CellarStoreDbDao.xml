<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="io.renren.modules.cellar.dao.CellarStoreDbDao">

	<!-- 可根据自己的需求，是否要使用 -->
    <resultMap type="io.renren.modules.cellar.entity.CellarStoreDbEntity" id="cellarStoreDbMap">
        <result property="storeId" column="store_id"/>
        <result property="storeName" column="store_name"/>
        <result property="provinceId" column="province_id"/>
        <result property="cityId" column="city_id"/>
        <result property="areaId" column="area_id"/>
        <result property="detailedAddress" column="detailed_address"/>
        <result property="storeDiscounts" column="store_discounts"/>
        <result property="supportTheirOwn" column="support_their_own"/>
        <result property="full" column="full"/>
        <result property="reductionOf" column="reduction_of"/>
        <result property="storeBackgroundMap" column="store_background_map"/>
        <result property="storeHeadPicture" column="store_head_picture"/>
        <result property="longitude" column="longitude"/>
        <result property="latitude" column="latitude"/>
        <result property="createTime" column="create_time"/>
        <result property="state" column="state"/>
        <result property="distance" column="distance"/>
    </resultMap>


    <select id="nearStoreList" parameterType="io.renren.modules.cellar.entity.CellarStoreDbEntity" resultMap="cellarStoreDbMap">
        SELECT
        a.*
        ,(
            6371 * acos(
              cos( radians( a.latitude ) ) * cos( radians( #{ew.latitude} ) ) * cos( radians( #{ew.longitude} ) - radians( a.longitude ) ) + sin( radians( a.latitude ) ) * sin( radians( #{ew.latitude} ) )
            )
        ) AS distance
        FROM
        cellar_store_db a
        WHERE
          1 = 1
        <if test="ew.state != null and ew.state != ''">
          AND  a.state = #{ew.state}
        </if>
        <if test="ew.key != null and ew.key != ''">
          AND  a.store_name like CONCAT('%','#{ew.key}','%')
        </if>
        <if test="ew.storeId != null and ew.storeId != ''">
          AND a.store_id = #{ew.storeId}
        </if>
        having distance &lt; #{ew.distance}
        ORDER BY
            distance
    </select>


</mapper>